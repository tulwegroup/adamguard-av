# AdamGuard Pro - Diagnose and Fix Deployment
# Run this to diagnose and fix common deployment issues

name: AdamGuard Diagnose & Fix

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  diagnose:
    name: Diagnose Deployment Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        run: echo "AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV

      - name: Diagnose ALB and Target Group
        id: diagnose
        run: |
          echo "=========================================="
          echo "ðŸ” DIAGNOSING DEPLOYMENT ISSUES"
          echo "=========================================="
          echo ""
          
          # Check ALB
          echo "1. Checking Application Load Balancer..."
          ALB_DNS=$(aws elbv2 describe-load-balancers --names adamguard-alb --query "LoadBalancers[0].DNSName" --output text 2>/dev/null || echo "NOT_FOUND")
          ALB_ARN=$(aws elbv2 describe-load-balancers --names adamguard-alb --query "LoadBalancers[0].LoadBalancerArn" --output text 2>/dev/null || echo "NOT_FOUND")
          echo "   ALB DNS: $ALB_DNS"
          echo "   ALB ARN: $ALB_ARN"
          
          # Check ALB Security Group
          echo ""
          echo "2. Checking ALB Security Groups..."
          ALB_SG=$(aws elbv2 describe-load-balancers --names adamguard-alb --query "LoadBalancers[0].SecurityGroups[0]" --output text 2>/dev/null || echo "NOT_FOUND")
          echo "   ALB Security Group: $ALB_SG"
          
          if [ "$ALB_SG" != "NOT_FOUND" ] && [ "$ALB_SG" != "None" ]; then
            echo ""
            echo "   Security Group Inbound Rules:"
            aws ec2 describe-security-groups --group-ids $ALB_SG --query "SecurityGroups[0].IpPermissions" --output table 2>/dev/null || echo "   Could not fetch rules"
          fi
          
          # Check Target Group
          echo ""
          echo "3. Checking Target Group..."
          TG_ARN=$(aws elbv2 describe-target-groups --names adamguard-tg --query "TargetGroups[0].TargetGroupArn" --output text 2>/dev/null || echo "NOT_FOUND")
          echo "   Target Group ARN: $TG_ARN"
          
          if [ "$TG_ARN" != "NOT_FOUND" ] && [ "$TG_ARN" != "None" ]; then
            echo ""
            echo "   Target Health:"
            aws elbv2 describe-target-health --target-group-arn $TG_ARN --output table 2>/dev/null || echo "   No targets registered"
          fi
          
          # Check Listeners
          echo ""
          echo "4. Checking Listeners..."
          if [ "$ALB_ARN" != "NOT_FOUND" ] && [ "$ALB_ARN" != "None" ]; then
            aws elbv2 describe-listeners --load-balancer-arn $ALB_ARN --query "Listeners[*].[Protocol,Port,DefaultActions[0].Type]" --output table 2>/dev/null || echo "   No listeners found"
          fi
          
          # Check ECS Service
          echo ""
          echo "5. Checking ECS Service..."
          SERVICE_STATUS=$(aws ecs describe-services --cluster adamguard-prod --services adamguard-prod-service --query "services[0].status" --output text 2>/dev/null || echo "NOT_FOUND")
          RUNNING_COUNT=$(aws ecs describe-services --cluster adamguard-prod --services adamguard-prod-service --query "services[0].runningCount" --output text 2>/dev/null || echo "0")
          DESIRED_COUNT=$(aws ecs describe-services --cluster adamguard-prod --services adamguard-prod-service --query "services[0].desiredCount" --output text 2>/dev/null || echo "0")
          echo "   Service Status: $SERVICE_STATUS"
          echo "   Running Tasks: $RUNNING_COUNT / $DESIRED_COUNT desired"
          
          # Check recent tasks
          echo ""
          echo "6. Recent Task Status..."
          TASK_ARNS=$(aws ecs list-tasks --cluster adamguard-prod --service-name adamguard-prod-service --query "taskArns" --output text 2>/dev/null || echo "")
          if [ -n "$TASK_ARNS" ]; then
            aws ecs describe-tasks --cluster adamguard-prod --tasks $TASK_ARNS --query "tasks[*].[lastStatus,healthStatus,stoppedReason]" --output table 2>/dev/null || echo "   No tasks found"
          else
            echo "   No tasks running"
          fi

          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "alb_sg=$ALB_SG" >> $GITHUB_OUTPUT

      - name: Fix Security Group Rules
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ”§ FIXING SECURITY GROUP RULES"
          echo "=========================================="
          
          # Get VPC
          VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query "Vpcs[0].VpcId" --output text)
          echo "VPC: $VPC_ID"
          
          # Get ALB security group
          ALB_SG="${{ steps.diagnose.outputs.alb_sg }}"
          
          if [ -z "$ALB_SG" ] || [ "$ALB_SG" = "None" ]; then
            echo "Creating new security group for ALB..."
            ALB_SG=$(aws ec2 create-security-group \
              --group-name adamguard-alb-sg \
              --description "AdamGuard ALB Security Group" \
              --vpc-id $VPC_ID \
              --query "GroupId" \
              --output text 2>/dev/null || aws ec2 describe-security-groups --filters "Name=group-name,Values=adamguard-alb-sg" --query "SecurityGroups[0].GroupId" --output text)
          fi
          
          echo "Using Security Group: $ALB_SG"
          
          # Add inbound rules
          echo "Adding inbound rules..."
          aws ec2 authorize-security-group-ingress --group-id $ALB_SG --protocol tcp --port 80 --cidr 0.0.0.0/0 2>/dev/null || echo "Port 80 rule exists"
          aws ec2 authorize-security-group-ingress --group-id $ALB_SG --protocol tcp --port 443 --cidr 0.0.0.0/0 2>/dev/null || echo "Port 443 rule exists"
          
          # Update ALB to use this security group
          ALB_ARN=$(aws elbv2 describe-load-balancers --names adamguard-alb --query "LoadBalancers[0].LoadBalancerArn" --output text 2>/dev/null)
          
          if [ "$ALB_ARN" != "None" ] && [ -n "$ALB_ARN" ]; then
            echo "Updating ALB security group..."
            aws elbv2 set-security-groups --load-balancer-arn $ALB_ARN --security-groups $ALB_SG || echo "Could not update ALB security group"
          fi
          
          echo "âœ… Security group rules updated"

      - name: Restart ECS Service
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ”„ RESTARTING ECS SERVICE"
          echo "=========================================="
          
          # Force new deployment
          echo "Forcing new deployment..."
          aws ecs update-service \
            --cluster adamguard-prod \
            --service adamguard-prod-service \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }} || echo "Could not update service"
          
          echo "Waiting for service to stabilize..."
          sleep 30

      - name: Wait and Check Health
        run: |
          echo ""
          echo "=========================================="
          echo "â³ WAITING FOR SERVICE TO START"
          echo "=========================================="
          
          TG_ARN=$(aws elbv2 describe-target-groups --names adamguard-tg --query "TargetGroups[0].TargetGroupArn" --output text 2>/dev/null)
          
          for i in {1..12}; do
            echo "Checking target health (attempt $i/12)..."
            HEALTH=$(aws elbv2 describe-target-health --target-group-arn $TG_ARN --query "TargetHealthDescriptions[*].TargetHealth.State" --output text 2>/dev/null || echo "empty")
            echo "Target Health: $HEALTH"
            
            if [[ "$HEALTH" == *"healthy"* ]]; then
              echo "âœ… Targets are healthy!"
              break
            fi
            
            sleep 30
          done

      - name: Output Final Status
        run: |
          ALB_DNS="${{ steps.diagnose.outputs.alb_dns }}"
          
          echo ""
          echo "=========================================="
          echo "ðŸ“Š FINAL STATUS"
          echo "=========================================="
          echo ""
          echo "ðŸ“± Access your application at:"
          echo "   http://$ALB_DNS"
          echo ""
          echo "If still not working, check:"
          echo "1. AWS ECS Console: https://console.aws.amazon.com/ecs/home?region=${{ env.AWS_REGION }}#/clusters/adamguard-prod"
          echo "2. Target Group Health: https://console.aws.amazon.com/ec2/v2/home?region=${{ env.AWS_REGION }}#TargetGroups"
          echo "3. ALB Health: https://console.aws.amazon.com/ec2/v2/home?region=${{ env.AWS_REGION }}#LoadBalancers"
          echo "=========================================="
